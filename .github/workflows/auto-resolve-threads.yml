name: Auto Resolve Review Threads

on:
  pull_request:
    types: [synchronize]  # PRì´ ì—…ë°ì´íŠ¸ë  ë•Œë§Œ ì‹¤í–‰

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  auto-resolve:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # 5ë¶„ ì œí•œ
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Auto Resolve Review Threads
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          use_sticky_comment: false
          claude_args: |
            --model haiku
            --allowedTools "Bash(gh api:*),Bash(gh pr:*),Read,Grep,Glob"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## ì‘ì—…: í•´ê²°ëœ ë¦¬ë·° ìŠ¤ë ˆë“œ ìë™ Resolve

            ì´ PRì˜ ì—´ë ¤ìˆëŠ” ë¦¬ë·° ìŠ¤ë ˆë“œë¥¼ í™•ì¸í•˜ê³ , ì§€ì ëœ ì´ìŠˆê°€ í•´ê²°ëœ ê²ƒì€ ìë™ìœ¼ë¡œ Resolve í•´ì£¼ì„¸ìš”.

            **ì¤‘ìš”: ë‹¨ìˆœíˆ ì½”ë“œê°€ ìˆ˜ì •ë˜ì—ˆë‹¤ê³  ë¬´ì¡°ê±´ resolveí•˜ì§€ ë§ˆì„¸ìš”. ë°˜ë“œì‹œ ì•„ë˜ ê¸°ì¤€ì— ë”°ë¼ ì‹ ì¤‘í•˜ê²Œ íŒë‹¨í•˜ì„¸ìš”.**

            ### 1ë‹¨ê³„: ë¯¸í•´ê²° ìŠ¤ë ˆë“œ ì¡°íšŒ

            ```bash
            gh api graphql -f query='
              query {
                repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                  pullRequest(number: ${{ github.event.pull_request.number }}) {
                    reviewThreads(first: 100) {
                      nodes {
                        id
                        isResolved
                        comments(first: 10) {
                          nodes {
                            id
                            body
                            path
                            line
                            diffHunk
                          }
                        }
                      }
                    }
                  }
                }
              }'
            ```

            ### 2ë‹¨ê³„: ê° ë¯¸í•´ê²° ìŠ¤ë ˆë“œ ê²€ì¦

            ê° ìŠ¤ë ˆë“œì— ëŒ€í•´:
            1. í•´ë‹¹ íŒŒì¼ì˜ **í˜„ì¬ ì½”ë“œ**ë¥¼ Read ë„êµ¬ë¡œ ì½ì–´ì„œ í™•ì¸
            2. ì›ë˜ ì§€ì ëœ ì´ìŠˆì™€ í˜„ì¬ ì½”ë“œë¥¼ ë¹„êµí•˜ì—¬ íŒë‹¨

            **íŒë‹¨ ê¸°ì¤€:**

            **âœ… RESOLVED (ì™„ì „ í•´ê²°)**
            - ì§€ì ëœ ì´ìŠˆê°€ ì™„ì „íˆ í•´ê²°ë˜ì—ˆìŒ
            - ìˆ˜ì • ê³¼ì •ì—ì„œ ìƒˆë¡œìš´ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ
            - ì½”ë“œê°€ CLAUDE.mdì˜ ê·œì¹™ì„ ì¤€ìˆ˜í•¨

            **ì¡°ì¹˜:**
            ```bash
            # 1. Resolve
            gh api graphql -f query='
              mutation {
                resolveReviewThread(input: {threadId: "THREAD_ID"}) {
                  thread { isResolved }
                }
              }'

            # 2. ë‹µê¸€ ë‹¬ê¸°
            gh api repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/pulls/comments/COMMENT_ID/replies \
              -f body='âœ… ì´ìŠˆê°€ ìˆ˜ì •ë˜ì–´ ìë™ìœ¼ë¡œ Resolve í•©ë‹ˆë‹¤.'
            ```

            **âš ï¸ PARTIALLY_FIXED (ë¶€ë¶„ í•´ê²° / ìƒˆë¡œìš´ ë¬¸ì œ ë°œìƒ)**
            - ìˆ˜ì •ì€ í–ˆì§€ë§Œ ë¶ˆì™„ì „í•¨ (ì˜ˆ: íƒ€ì… ë¬¸ì œëŠ” í•´ê²°í–ˆì§€ë§Œ ë‹¤ë¥¸ ì•ˆí‹°íŒ¨í„´ ë„ì…)
            - ì›ë˜ ì´ìŠˆëŠ” í•´ê²°í–ˆì§€ë§Œ ìˆ˜ì • ê³¼ì •ì—ì„œ ìƒˆë¡œìš´ ë¬¸ì œê°€ ë°œìƒí•¨
            - ê°œì„ ì€ ë˜ì—ˆì§€ë§Œ ì™„ì „í•˜ì§€ ì•ŠìŒ

            **ì¡°ì¹˜:** Resolve í•˜ì§€ ì•Šê³  ìƒì„¸í•œ í”¼ë“œë°± ëŒ“ê¸€ ì‘ì„±
            ```bash
            gh api repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/pulls/comments/COMMENT_ID/replies \
              -f body='âš ï¸ **ë¶€ë¶„ì ìœ¼ë¡œë§Œ ìˆ˜ì •ë¨**

            [êµ¬ì²´ì ì¸ ë¬¸ì œì  ì„¤ëª…]

            **ì¶”ê°€ ìˆ˜ì • í•„ìš”:**
            - [ìƒì„¸í•œ ê°œì„  ë°©ì•ˆ 1]
            - [ìƒì„¸í•œ ê°œì„  ë°©ì•ˆ 2]'
            ```

            **âŒ NOT_FIXED (ë¯¸í•´ê²°)**
            - ì•„ì§ ìˆ˜ì •ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì „í˜€ ë°˜ì˜ë˜ì§€ ì•ŠìŒ
            - ì½”ë“œê°€ ë³€ê²½ë˜ì§€ ì•ŠìŒ

            **ì¡°ì¹˜:** Resolve í•˜ì§€ ì•Šê³  ìƒíƒœ ì•Œë¦¼
            ```bash
            gh api repos/${{ github.repository_owner }}/${{ github.event.repository.name }}/pulls/comments/COMMENT_ID/replies \
              -f body='âŒ ì•„ì§ ìˆ˜ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

            [í˜„ì¬ ìƒíƒœ ì„¤ëª…]'
            ```

            **ğŸ¤· CANNOT_VERIFY (ê²€ì¦ ë¶ˆê°€)**
            - ì½”ë“œë§Œìœ¼ë¡œëŠ” íŒë‹¨í•  ìˆ˜ ì—†ìŒ (ì‹¤í–‰ì´ í•„ìš”í•œ ê²½ìš°)
            - íŒŒì¼ì´ ì‚­ì œë˜ì—ˆê±°ë‚˜ í¬ê²Œ ë¦¬íŒ©í† ë§ë¨
            - ì»¨í…ìŠ¤íŠ¸ê°€ ë¶€ì¡±í•¨

            **ì¡°ì¹˜:** ìŠ¤í‚µ (ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•ŠìŒ)

            ### 3ë‹¨ê³„: ê²°ê³¼ ìš”ì•½

            ì²˜ë¦¬ ì™„ë£Œ í›„, ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ìš”ì•½ì„ ì¶œë ¥í•˜ì„¸ìš”:

            ```
            ğŸ“Š ë¦¬ë·° ìŠ¤ë ˆë“œ ìë™ Resolve ê²°ê³¼:
               âœ… Resolved: Nê°œ
               âš ï¸  í”¼ë“œë°± ì œê³µ: Nê°œ
               âŒ ë¯¸í•´ê²°: Nê°œ
               â­ï¸  ìŠ¤í‚µ: Nê°œ
            ```

            ### ì£¼ì˜ì‚¬í•­

            - CLAUDE.mdì˜ Code Review Guidelinesë¥¼ ì°¸ê³ í•˜ì—¬ íŒë‹¨í•˜ì„¸ìš”
            - ì˜ì‹¬ìŠ¤ëŸ¬ìš°ë©´ resolveí•˜ì§€ ë§ê³  PARTIALLY_FIXEDë‚˜ CANNOT_VERIFYë¡œ ì²˜ë¦¬í•˜ì„¸ìš”
            - ê° íŒë‹¨ì— ëŒ€í•œ ê·¼ê±°ë¥¼ ëª…í™•íˆ í•˜ì„¸ìš”
