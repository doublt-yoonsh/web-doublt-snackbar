name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - '**/*.json'
      - '**/*.yml'
      - '**/*.yaml'
      - '!**/*.test.ts'
      - '!**/*.test.tsx'
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  initial-review:
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review with Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          REPO: ${{ github.repository }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          git fetch origin "$BASE_REF"
          DIFF=$(git diff "origin/$BASE_REF"...HEAD)

          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import subprocess

          diff = os.environ['DIFF']
          api_key = os.environ['ANTHROPIC_API_KEY']
          pr_number = os.environ['PR_NUMBER']
          pr_title = os.environ['PR_TITLE']
          pr_author = os.environ['PR_AUTHOR']
          repo = os.environ['REPO']

          prompt = f"""ë‹¹ì‹ ì€ ì½”ë“œ ë¦¬ë·° ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ì•„ëž˜ PRì„ ê²€í† í•´ì£¼ì„¸ìš”.

## PR ì •ë³´
- ì œëª©: {pr_title}
- ìž‘ì„±ìž: {pr_author}
- ë ˆí¬: {repo}

## ë³€ê²½ì‚¬í•­
```diff
{diff}
```

## ë¦¬ë·° ê¸°ì¤€ (CLAUDE.md ì°¸ê³ )
- [Critical] ë²„ê·¸, ë³´ì•ˆ ì·¨ì•½ì , íƒ€ìž… ì•ˆì •ì„± ë¬¸ì œ
- [Warning] ì•„í‚¤í…ì²˜ ìœ„ë°˜, ì„±ëŠ¥ ì´ìŠˆ, ì—ëŸ¬ í•¸ë“¤ë§ ëˆ„ë½
- [Suggestion] ì½”ë“œ ê°œì„  ì œì•ˆ

## ì¶œë ¥ í˜•ì‹
```markdown
## ðŸ¤– Claude Code Review

### ðŸ“Š Summary
(2-3ì¤„ ìš”ì•½)

### ðŸ” Issues Found

#### ðŸ”´ Critical
- íŒŒì¼ëª…:ì¤„ë²ˆí˜¸ - ì´ìŠˆ ì„¤ëª…

#### ðŸŸ¡ Warning
- íŒŒì¼ëª…:ì¤„ë²ˆí˜¸ - ì´ìŠˆ ì„¤ëª…

#### ðŸ’¡ Suggestion
- íŒŒì¼ëª…:ì¤„ë²ˆí˜¸ - ì œì•ˆ

### âœ… Good Points
- ìž˜ëœ ì 

### ðŸ“ Overall
Status: [âœ… Approved | ðŸ”´ Changes Requested]
```"""

          payload = {
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 16000,
              "messages": [{"role": "user", "content": prompt}]
          }

          result = subprocess.run([
              'curl', '-s', 'https://api.anthropic.com/v1/messages',
              '-H', 'Content-Type: application/json',
              '-H', f'x-api-key: {api_key}',
              '-H', 'anthropic-version: 2023-06-01',
              '-d', json.dumps(payload)
          ], capture_output=True, text=True)

          response = json.loads(result.stdout)
          review = response['content'][0]['text']

          subprocess.run(['gh', 'pr', 'comment', pr_number, '--body', review])
          PYTHON_SCRIPT

  incremental-review:
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review with Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BEFORE_SHA: ${{ github.event.before }}
          AFTER_SHA: ${{ github.event.after }}
        run: |
          DIFF=$(git diff "$BEFORE_SHA".."$AFTER_SHA")

          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import subprocess

          diff = os.environ['DIFF']
          api_key = os.environ['ANTHROPIC_API_KEY']
          pr_number = os.environ['PR_NUMBER']

          prompt = f"""ìƒˆ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ì¦ë¶„ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”.

## ë³€ê²½ì‚¬í•­
```diff
{diff}
```

ì´ë²ˆ ì»¤ë°‹ì—ì„œ ìƒˆë¡œ ì¶”ê°€ëœ ì´ìŠˆë§Œ ë¦¬ë·°í•˜ì„¸ìš”.

## ì¶œë ¥ í˜•ì‹
```markdown
## ðŸ”„ Incremental Review

### New Issues
- ðŸ”´ [Critical] ì´ìŠˆ
- ðŸŸ¡ [Warning] ì´ìŠˆ

### Status: [âœ… Approved | ðŸ”´ Changes Requested]
```"""

          payload = {
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 16000,
              "messages": [{"role": "user", "content": prompt}]
          }

          result = subprocess.run([
              'curl', '-s', 'https://api.anthropic.com/v1/messages',
              '-H', 'Content-Type: application/json',
              '-H', f'x-api-key: {api_key}',
              '-H', 'anthropic-version: 2023-06-01',
              '-d', json.dumps(payload)
          ], capture_output=True, text=True)

          response = json.loads(result.stdout)
          review = response['content'][0]['text']

          subprocess.run(['gh', 'pr', 'comment', pr_number, '--body', review])
          PYTHON_SCRIPT

  mention-response:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Respond to mention
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          import subprocess

          comment = os.environ['COMMENT_BODY']
          api_key = os.environ['ANTHROPIC_API_KEY']
          pr_number = os.environ['PR_NUMBER']

          payload = {
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 8000,
              "messages": [{"role": "user", "content": comment}]
          }

          result = subprocess.run([
              'curl', '-s', 'https://api.anthropic.com/v1/messages',
              '-H', 'Content-Type: application/json',
              '-H', f'x-api-key: {api_key}',
              '-H', 'anthropic-version: 2023-06-01',
              '-d', json.dumps(payload)
          ], capture_output=True, text=True)

          response = json.loads(result.stdout)
          reply = response['content'][0]['text']

          subprocess.run(['gh', 'pr', 'comment', pr_number, '--body', reply])
          PYTHON_SCRIPT
