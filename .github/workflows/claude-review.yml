name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          use_sticky_comment: true
          claude_args: |
            --model sonnet
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh api:*),Bash(gh pr:*)"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## 0ë‹¨ê³„: ê¸°ì¡´ ë¦¬ë·° ìŠ¤ë ˆë“œ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)

            ë¦¬ë·°ë¥¼ ì‹œì‘í•˜ê¸° ì „ì—, ë¨¼ì € ì´ PRì˜ ê¸°ì¡´ ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ ì¡°íšŒí•˜ì„¸ìš”:
            `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments --jq '.[].body'`

            ì´ë¯¸ ì§€ì ëœ ì´ìŠˆì™€ ë™ì¼í•œ íŒŒì¼/ë™ì¼í•œ ë¬¸ì œì— ëŒ€í•´ì„œëŠ” ìƒˆë¡œìš´ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¥¼ ë‹¬ì§€ ë§ˆì„¸ìš”.
            ìƒˆë¡œ ë°œê²¬ëœ ì´ìŠˆ ë˜ëŠ” ì´ì „ì— ì§€ì ë˜ì§€ ì•Šì€ ì´ìŠˆë§Œ ì½”ë©˜íŠ¸í•˜ì„¸ìš”.

            ## 1ë‹¨ê³„: ì½”ë“œ ë¦¬ë·°

            CLAUDE.mdì˜ Code Review Guidelinesë¥¼ ì°¸ê³ í•˜ì—¬ ì´ PRì˜ ì½”ë“œ ë³€ê²½ì‚¬í•­ì„ ë¦¬ë·°í•´ì£¼ì„¸ìš”.

            1. `gh pr diff ${{ github.event.pull_request.number }}`ë¡œ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.
            2. 0ë‹¨ê³„ì—ì„œ í™•ì¸í•œ ê¸°ì¡´ ì½”ë©˜íŠ¸ì™€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ìƒˆë¡œìš´ ì´ìŠˆë§Œ `mcp__github_inline_comment__create_inline_comment` ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ë¼ì¸ ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ ë‹¬ì•„ì£¼ì„¸ìš”.
            3. ì „ì²´ ë¦¬ë·° ìš”ì•½ì€ `gh pr comment ${{ github.event.pull_request.number }}`ë¡œ PRì— ì½”ë©˜íŠ¸ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

            ë°˜ë“œì‹œ ë°œê²¬í•œ ëª¨ë“  ì´ìŠˆë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì í•˜ê³ , íŒŒì¼ëª…ê³¼ ì¤„ë²ˆí˜¸ë¥¼ ëª…ì‹œí•´ì£¼ì„¸ìš”.

            ## 2ë‹¨ê³„: ìµœì¢… ë¦¬ë·° íŒì •

            ì½”ë“œ ë¦¬ë·°ë¥¼ ì™„ë£Œí•œ í›„, ë°œê²¬í•œ ì´ìŠˆë¥¼ ì§‘ê³„í•˜ê³  ìµœì¢… íŒì •ì„ ì œì¶œí•˜ì„¸ìš”.

            **ì°¸ê³ :** ë¦¬ë·° ìŠ¤ë ˆë“œ ìë™ ResolveëŠ” ë³„ë„ ì›Œí¬í”Œë¡œìš°(`auto-resolve-threads.yml`)ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

            **1. ì´ìŠˆ ì§‘ê³„**
            ë¦¬ë·°ì—ì„œ ë°œê²¬í•œ ì´ìŠˆë¥¼ ë¶„ë¥˜í•˜ì—¬ ì¹´ìš´íŠ¸í•˜ì„¸ìš”:
            - Critical: Nê°œ
            - Warning: Nê°œ
            - Suggestion: Nê°œ

            **2. íŒì • ê¸°ì¤€**
            - **Critical ì´ìŠˆê°€ 1ê°œë¼ë„ ìˆìœ¼ë©´** â†’ Request Changes
            - **Critical ì´ìŠˆê°€ ì—†ìœ¼ë©´** â†’ Approve (Warning/Suggestionì€ ìˆì–´ë„ ìŠ¹ì¸)

            **3. íŒì • ì œì¶œ**

            ```bash
            # Critical ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body "âŒ Critical ì´ìŠˆê°€ ë°œê²¬ë˜ì–´ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

            ğŸ“Š ë¦¬ë·° ê²°ê³¼:
            - ğŸ”´ Critical: [N]ê°œ
            - ğŸŸ¡ Warning: [N]ê°œ
            - ğŸ’¡ Suggestion: [N]ê°œ"

            # Critical ì´ìŠˆê°€ ì—†ëŠ” ê²½ìš° (Warning/Suggestionë§Œ ìˆì–´ë„ OK)
            gh pr review ${{ github.event.pull_request.number }} --approve --body "âœ… ì½”ë“œ ë¦¬ë·°ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤.

            ğŸ“Š ë¦¬ë·° ê²°ê³¼:
            - ğŸ”´ Critical: 0ê°œ
            - ğŸŸ¡ Warning: [N]ê°œ
            - ğŸ’¡ Suggestion: [N]ê°œ"
            ```

            **ì¤‘ìš”:** [N]ì„ ì‹¤ì œ ìˆ«ìë¡œ ëŒ€ì²´í•˜ì—¬ ì œì¶œí•˜ì„¸ìš”.
