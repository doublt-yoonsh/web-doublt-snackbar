name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'src/**/*.{ts,tsx}'
      - '**/*.{json,yml,yaml}'
      - '!**/*.test.{ts,tsx}'
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# ë™ì¼ PRì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: claude-review-${{ github.event.pull_request.number || github.event.issue.number }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # PR ìƒì„± ì‹œ ì´ˆê¸° ì „ì²´ ë¦¬ë·°
  # ===========================================
  initial-review:
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'opened' &&
      github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Initial Code Review
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          claude --non-interactive --prompt "$(cat <<'EOF'
            REPO: ${{ github.repository }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
            BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
            PR_TITLE: ${{ github.event.pull_request.title }}
            PR_AUTHOR: ${{ github.event.pull_request.user.login }}

            ì´ PRì— ëŒ€í•´ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”.

            ## ë³€ê²½ì‚¬í•­ í™•ì¸
            `git diff origin/${BASE_BRANCH}...HEAD` ë¡œ ì „ì²´ ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.

            ## ë¦¬ë·° ê¸°ì¤€ (CLAUDE.md ì°¸ê³ )
            - [Critical] ë²„ê·¸, ë³´ì•ˆ ì·¨ì•½ì , ë©”ëª¨ë¦¬ ëˆ„ìˆ˜, íƒ€ì… ì•ˆì •ì„± ë¬¸ì œ
            - [Warning] ì•„í‚¤í…ì²˜ ìœ„ë°˜, ì„±ëŠ¥ ì´ìŠˆ, ì—ëŸ¬ í•¸ë“¤ë§ ëˆ„ë½
            - [Suggestion] ì½”ë“œ ê°œì„  ì œì•ˆ, ê°€ë…ì„± í–¥ìƒ

            ## ë¦¬ë·° ë°©ë²•
            1. ì „ì²´ ìš”ì•½ì€ `gh pr comment ${PR_NUMBER} --body "ë‚´ìš©"` ìœ¼ë¡œ PRì— ì½”ë©˜íŠ¸
            2. íŠ¹ì • ì½”ë“œ ë¼ì¸ ì´ìŠˆëŠ” `gh pr comment ${PR_NUMBER} --body "ë‚´ìš©" --body-file - <<< "ë‚´ìš©"` ë¡œ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ ì‘ì„±
            3. ì‹¬ê°í•œ ì´ìŠˆê°€ ìˆìœ¼ë©´ `gh pr review ${PR_NUMBER} --request-changes`
            4. ë¬¸ì œì—†ìœ¼ë©´ `gh pr review ${PR_NUMBER} --approve`

            ## ì¶œë ¥ í˜•ì‹
            PR ì½”ë©˜íŠ¸ë¡œ ì•„ë˜ í˜•ì‹ ì‚¬ìš©:
            ```markdown
            ## ğŸ¤– Claude Code Review

            ### ğŸ“Š Summary
            (2-3ì¤„ë¡œ ë³€ê²½ì‚¬í•­ ìš”ì•½)

            ### ğŸ” Issues Found

            #### ğŸ”´ Critical
            - íŒŒì¼ëª…:ì¤„ë²ˆí˜¸ - ì´ìŠˆ ì„¤ëª…

            #### ğŸŸ¡ Warning
            - íŒŒì¼ëª…:ì¤„ë²ˆí˜¸ - ì´ìŠˆ ì„¤ëª…

            #### ğŸ’¡ Suggestion
            - íŒŒì¼ëª…:ì¤„ë²ˆí˜¸ - ì œì•ˆ ì‚¬í•­

            ### âœ… Good Points
            - ì˜ëœ ë¶€ë¶„ë“¤

            ### ğŸ“ Overall
            Status: [âœ… Approved | ğŸ”´ Changes Requested]
            ```
          EOF
          )"

  # ===========================================
  # ìƒˆ ì»¤ë°‹ í‘¸ì‹œ ì‹œ ì¦ë¶„ ë¦¬ë·°
  # ===========================================
  incremental-review:
    if: github.event_name == 'pull_request' && github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Incremental Review with Auto-Resolve
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          claude --non-interactive --prompt "$(cat <<'EOF'
            REPO: ${{ github.repository }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
            BEFORE_SHA: ${{ github.event.before }}
            AFTER_SHA: ${{ github.event.after }}

            ìƒˆ ì»¤ë°‹ì´ í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì‘ì—…í•˜ì„¸ìš”.

            ## Step 1: ì´ì „ ë¦¬ë·° ì½”ë©˜íŠ¸ ì¡°íšŒ ë° ê¸°ì–µ
            ```bash
            gh api repos/${{ github.repository }}/pulls/${PR_NUMBER}/comments
            ```
            - ë‚´ê°€ ë‚¨ê¸´ ì½”ë©˜íŠ¸ë“¤(github-actions bot)ì„ í™•ì¸
            - ê° ì½”ë©˜íŠ¸ì˜ íŒŒì¼ ê²½ë¡œ, ë¼ì¸, ë‚´ìš©ì„ ê¸°ì–µí•´ë‘ì„¸ìš”

            ## Step 2: í•´ê²°ëœ ì´ìŠˆ í™•ì¸ ë° ì‘ë‹µ
            ê° ì´ì „ ì½”ë©˜íŠ¸ì— ëŒ€í•´:
            1. í•´ë‹¹ ì½”ë“œ ë¼ì¸ì´ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ í˜„ì¬ ì½”ë“œì™€ ë¹„êµ
            2. ìˆ˜ì •ë˜ì—ˆìœ¼ë©´ í•´ë‹¹ ìŠ¤ë ˆë“œì— "âœ… Fixed in ${AFTER_SHA:0:7}" ë‹µê¸€
            3. ì—¬ì „íˆ ë¬¸ì œê°€ ìˆìœ¼ë©´ "âš ï¸ Still needs attention" ë‹µê¸€

            ## Step 3: ìƒˆ ë³€ê²½ì‚¬í•­ ë¦¬ë·°
            ```bash
            git diff ${BEFORE_SHA}..${AFTER_SHA}
            ```
            - ì´ë²ˆ ì»¤ë°‹ì—ì„œ ë³€ê²½ëœ ë¶€ë¶„ë§Œ ë¦¬ë·°
            - **ì¤‘ìš”: Step 1ì—ì„œ ê¸°ì–µí•œ ì´ì „ ì´ìŠˆëŠ” ë‹¤ì‹œ ì–¸ê¸‰í•˜ì§€ ë§ ê²ƒ**
            - ì™„ì „íˆ ìƒˆë¡œìš´ ì´ìŠˆë§Œ ì½”ë©˜íŠ¸

            ## Step 4: ìš”ì•½ ì½”ë©˜íŠ¸
            PRì— ìš”ì•½ ì½”ë©˜íŠ¸ ì‘ì„±:
            ```markdown
            ## ğŸ”„ Incremental Review (${AFTER_SHA:0:7})

            ### Resolved Issues
            - âœ… [ì´ìŠˆ ë‚´ìš©] (file.ts:42) - Fixed

            ### New Issues
            - ğŸ”´ [Critical] ìƒˆ ì´ìŠˆ ë‚´ìš©
            - ğŸŸ¡ [Warning] ìƒˆ ì´ìŠˆ ë‚´ìš©

            ### Status: [Approved âœ… / Changes Requested ğŸ”´]
            ```
          EOF
          )"

  # ===========================================
  # @claude ë©˜ì…˜ ëŒ€ì‘
  # ===========================================
  mention-response:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 10

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Respond to Mention
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          claude --non-interactive --prompt "$COMMENT_BODY"
